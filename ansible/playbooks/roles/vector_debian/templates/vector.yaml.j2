# Vector Configuration File
# Generated by Ansible for {{ ansible_hostname }}

# Data Directory
data_dir: /var/lib/vector

# Sources - Log Collection
sources:
  # Debian System Logs
  debian_syslog:
    type: file
    include:
      - /var/log/syslog
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

  # MongoDB Logs (if exists)
  mongodb_logs:
    type: file
    include:
      - /var/log/mongodb/*.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode
    ignore_older_secs: 600

  # HAProxy Logs (if exists)
  haproxy_logs:
    type: file
    include:
      - /var/log/haproxy.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode
    ignore_older_secs: 600

# Transforms - Add Metadata
transforms:
  add_metadata:
    type: remap
    inputs:
      - debian_syslog
      - mongodb_logs
      - haproxy_logs
    source: |
      # Add hostname
      .hostname = get_hostname!()

      # Add node type
      .node_type = "debian"

      # Extract service name from file path
      if contains(string!(.file), "mongodb") {
        .service = "mongodb"
      } else if contains(string!(.file), "haproxy") {
        .service = "haproxy"
      } else {
        .service = "system"
      }

      # Parse log level
      if match(string!(.message), r'(?i)error|fatal|critical|err') {
        .log_level = "error"
      } else if match(string!(.message), r'(?i)warn|warning') {
        .log_level = "warn"
      } else {
        .log_level = "info"
      }

      # Add timestamp
      .timestamp = now()

      # Add VLAN info (if available)
      .vlan = "{{ vlan_id | default('100') }}"

# Sinks - Send to Redpanda
sinks:
  redpanda_logs:
    type: kafka
    inputs:
      - add_metadata
    bootstrap_servers: "{{ redpanda_host | default('192.168.2.90') }}:{{ redpanda_port | default('9092') }}"
    topic: "{{ redpanda_topic | default('logs') }}"
    encoding:
      codec: json
    compression: snappy

    # Buffer settings
    buffer:
      type: disk
      max_size: 268435488  # 256 MB (minimum required)
      when_full: block

    # Health check
    healthcheck:
      enabled: true
