# Vector Configuration File
# Literal IP/Port/Topic 적용

data_dir: /var/lib/vector

# Sources - Log Collection
sources:
  debian_syslog:
    type: file
    include:
      - /var/log/syslog
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

  mongodb_logs:
    type: file
    include:
      - /var/log/mongodb/*.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

  haproxy_logs:
    type: file
    include:
      - /var/log/haproxy.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

  jenkins_logs:
    type: file
    include:
      - /var/log/jenkins/*.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

# Transforms - Add Metadata
transforms:
  add_metadata:
    type: remap
    inputs:
      - debian_syslog
      - mongodb_logs
      - haproxy_logs
      - jenkins_logs
    source: |
      .hostname = get_hostname!()
      .node_type = "debian"

      if contains(string!(.file), "mongodb") { .service = "mongodb" }
      if contains(string!(.file), "haproxy") { .service = "haproxy" }
      if contains(string!(.file), "jenkins") { .service = "jenkins" }
      if exists(.systemd_unit) && contains(string!(.systemd_unit), "redpanda") { .service = "redpanda" }
      if !exists(.service) { .service = "system" }

      # Improved log level detection
      msg = downcase(string(.message) ?? "")
      if contains(msg, "error") || contains(msg, "fatal") || contains(msg, "panic") || contains(msg, "err") {
        .log_level = "error"
      } else if contains(msg, "warn") || contains(msg, "warning") {
        .log_level = "warn"
      } else if contains(msg, "debug") {
        .log_level = "debug"
      } else {
        .log_level = "info"
      }

      .timestamp = .timestamp || now()
      .vlan = "100"

# Sinks - Send to Redpanda
sinks:
  redpanda_sink:
    type: kafka
    inputs:
      - add_metadata
    bootstrap_servers: "192.168.2.90:9092"
    topic: "logs"
    encoding:
      codec: json
    compression: snappy

    buffer:
      type: disk
      max_size: 268435488
      when_full: block
    healthcheck:
      enabled: true
