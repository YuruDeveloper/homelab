data_dir: /var/lib/vector

# --- Sources ---
sources:
  AlpineMessages:
    type: file
    include: ["/var/log/messages"]

  PostgresqlLogs:
    type: file
    include: ["/var/log/postgresql/*.log", "/var/log/postgresql/*.json"]

  RedisLogs:
    type: file
    include: ["/var/log/redis/*.log"]

  NginxAccess:
    type: file
    include: ["/var/log/nginx/access.log"]

  NginxError:
    type: file
    include: ["/var/log/nginx/error.log"]

  DnsLogs:
    type: file
    include: ["/var/log/dns/*.log"]

  ZotLogs:
    type: file
    include: ["/var/log/zot/*.log"]

  RustfsLogs:
    type: file
    include: ["/var/log/rustfs/*.log"]

  GrafanaLogs:
    type: file
    include: ["/var/lib/grafana/log/*.log"]

  PrometheusLogs:
    type: file
    include: ["/var/log/prometheus/*.log"]

  LokiLogs:
    type: file
    include: ["/var/log/loki/*.log"]
  GiteaLogs:
    type: file
    include: ["/var/log/gitea/gitea/*.log"]
# --- Transforms ---
transforms:

  # 1. Nginx Access
  ParseNginxAccess:
    type: remap
    inputs:
      - NginxAccess
    source: |
      parsed, err = parse_json(.message)

      if err == null {
        .parsed = parsed
      }

      .status_code = to_int(.parsed.status) ?? 0
      .http_method = upcase(string!(.parsed.request_method))
      .request_path = .parsed.request_path

      path_lower = downcase(string!(.request_path))

      is_sqli = contains(path_lower, " union ") || contains(path_lower, " select ")
      is_scanner = .status_code == 444 || .http_method == "PROPFIND" || .http_method == "SEARCH"
      is_exploit = contains(path_lower, ".env") || contains(path_lower, "wp-admin") || contains(path_lower, ".git")

      if is_sqli {
        .attack_type = "sql_injection"
        .threat_score = 5
      } else if is_exploit {
        .attack_type = "exploit_probing"
        .threat_score = 7
      } else if is_scanner {
        .attack_type = "web_scanner"
        .threat_score = 3
      } else {
        .attack_type = "none"
        .threat_score = 0
      }

      if .status_code >= 500 {
        .log_level = "error"
      } else if .status_code >= 400 {
        .log_level = "warn"
      } else {
        .log_level = "info"
      }

      .log_type = "access"
      .service = "nginx"

  # 2. Nginx Error
  ParseNginxError:
    type: remap
    inputs:
      - NginxError
    source: |
      pattern = r'^(?P<ts>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?P<lvl>\w+)\] (?P<pid>\d+)#(?P<tid>\d+): (?:\*(?P<cid>\d+) )?(?P<msg>.*?)(?:, client: (?P<ip>[^,]+))?(?:, server: (?P<srv>[^,]+))?(?:, request: "(?P<req>[^"]+)")?'

      parsed, err = parse_regex(.message, pattern)

      if err == null {
        .parsed = parsed
      }

      .client_ip = .parsed.ip
      .error_level = .parsed.lvl

      lvl = downcase(string!(.parsed.lvl))

      if lvl == "crit" || lvl == "alert" || lvl == "emerg" {
        .log_level = "error"
      } else {
        .log_level = lvl
      }

      .error_message = .parsed.msg
      .request_path = .parsed.req

      msg_lower = downcase(string!(.error_message))
      req_lower = downcase(string!(.request_path))

      is_forbidden = contains(msg_lower, "forbidden") || contains(msg_lower, "access denied")
      is_exploit = contains(req_lower, ".env") || contains(req_lower, "../") || contains(req_lower, "etc/passwd")
      is_connection_issue = contains(msg_lower, "connection refused") || contains(msg_lower, "upstream")

      if is_exploit {
        .attack_type = "exploit_attempt"
        .threat_score = 8
      } else if is_forbidden {
        .attack_type = "access_denied"
        .threat_score = 4
      } else if is_connection_issue {
        .attack_type = "upstream_error"
        .threat_score = 1
      } else {
        .attack_type = "none"
        .threat_score = 0
      }

      .log_type = "error"
      .service = "nginx"

  # 3. Postgresql
  ParsePostgresql:
    type: remap
    inputs:
      - PostgresqlLogs
    source: |
      if contains(string!(.file), ".json") {
        parsed, err = parse_json(.message)
        if err == null {
          .parsed = parsed
        }
      }

      .log_type = "database"
      .service = "postgresql"

      if exists(.parsed.error_severity) {
        .log_level = downcase(string!(.parsed.error_severity))
      }

  # 4. Generic App Logs
  ParseAppLogs:
    type: remap
    inputs:
      - DnsLogs
      - ZotLogs
      - RustfsLogs
      - GrafanaLogs
      - PrometheusLogs
      - LokiLogs
      - GiteaLogs
    source: |
      msg = string!(.message)

      if starts_with(msg, "{") && ends_with(msg, "}") {
        parsed, err = parse_json(msg)
        if err == null {
          .parsed = parsed
        }
      }

  # 5. Metadata
  EnrichMetadata:
    type: remap
    inputs:
      - ParseNginxAccess
      - ParseNginxError
      - ParsePostgresql
      - ParseAppLogs
      - AlpineMessages
      - RedisLogscla
    source: |
      .hostname = get_hostname!()
      .node_type = "alpine"
      .vlan = "100"

      if !exists(.timestamp) {
        .timestamp = now()
      }

      if !exists(.log_level) {

        msg = downcase(string!(.message))

        if contains(msg, "error") || contains(msg, "fatal") || contains(msg, "panic") {
          .log_level = "error"
        } else if contains(msg, "warn") {
          .log_level = "warn"
        } else if contains(msg, "debug") {
          .log_level = "debug"
        } else {
          .log_level = "info"
        }
      }

      file_name = ""

      if exists(.file.path) {
        file_name = string!(.file.path)
      }

      if !exists(.service) {

        if contains(file_name, "postgresql") {
          .service = "postgresql"
        } else if contains(file_name, "redis") {
          .service = "redis"
        } else if contains(file_name, "dns") {
          .service = "dns"
        } else if contains(file_name, "zot") {
          .service = "zot"
        } else if contains(file_name, "rustfs") {
          .service = "rustfs"
        } else if contains(file_name, "grafana") {
          .service = "grafana"
        } else if contains(file_name, "prometheus") {
          .service = "prometheus"
        } else if contains(file_name, "gitea") {
          .service = "gitea"
        } else {
          .service = "system"
        }
      }

      .threat_score = to_int(.threat_score) ?? 0

      if !exists(.attack_type) {
        .attack_type = "none"
      }

# --- Sinks ---
sinks:
  RedpandaLogs:
    type: kafka
    inputs:
      - EnrichMetadata
    bootstrap_servers: "192.168.2.90:9092"
    topic: "logs"
    encoding:
      codec: json
    compression: snappy
    buffer:
      type: disk
      max_size: 268435488
      when_full: block
