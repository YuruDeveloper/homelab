# Vector Configuration File
# Generated by Ansible for {{ ansible_hostname }}

# Data Directory
data_dir: /var/lib/vector

# Sources - Log Collection
sources:
  # Alpine System Logs
  alpine_messages:
    type: file
    include:
      - /var/log/messages
    read_from: beginning
    fingerprint:
      strategy: device_and_inode

  # PostgreSQL Logs (if exists)
  postgresql_logs:
    type: file
    include:
      - /var/log/postgresql/*.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode
    ignore_older_secs: 600

  # Redis Logs (if exists)
  redis_logs:
    type: file
    include:
      - /var/log/redis/*.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode
    ignore_older_secs: 600

  # Nginx Access Logs (if exists)
  nginx_access:
    type: file
    include:
      - /var/log/nginx/access.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode
    ignore_older_secs: 600

  # Nginx Error Logs (if exists)
  nginx_error:
    type: file
    include:
      - /var/log/nginx/error.log
    read_from: beginning
    fingerprint:
      strategy: device_and_inode
    ignore_older_secs: 600

# Transforms - Add Metadata
transforms:
  add_metadata:
    type: remap
    inputs:
      - alpine_messages
      - postgresql_logs
      - redis_logs
      - nginx_access
      - nginx_error
    source: |
      # Add hostname
      .hostname = get_hostname!()

      # Add node type
      .node_type = "alpine"

      # Extract service name from file path
      if contains(string!(.file), "postgresql") {
        .service = "postgresql"
      } else if contains(string!(.file), "redis") {
        .service = "redis"
      } else if contains(string!(.file), "nginx") {
        .service = "nginx"
      } else {
        .service = "system"
      }

      # Parse log level
      if match(string!(.message), r'(?i)error|fatal|critical|err') {
        .log_level = "error"
      } else if match(string!(.message), r'(?i)warn|warning') {
        .log_level = "warn"
      } else {
        .log_level = "info"
      }

      # Add timestamp
      .timestamp = now()

      # Add VLAN info (if available)
      .vlan = "{{ vlan_id | default('100') }}"

# Sinks - Send to Redpanda
sinks:
  redpanda_logs:
    type: kafka
    inputs:
      - add_metadata
    bootstrap_servers: "{{ redpanda_host | default('192.168.2.90') }}:{{ redpanda_port | default('9092') }}"
    topic: "{{ redpanda_topic | default('logs') }}"
    encoding:
      codec: json
    compression: snappy

    # Buffer settings
    buffer:
      type: disk
      max_size: 268435488  # 256 MB (minimum required)
      when_full: block

    # Health check
    healthcheck:
      enabled: true
